r# PAUZ Backend Architecture

This document provides a comprehensive overview of the backend architecture for the PAUZ journaling application. It details the core components, data flow, and how the application leverages Raindrop's SmartBuckets and other AI-powered features.

## 1. Overview

The PAUZ backend is a FastAPI application that provides a set of APIs for the frontend to consume. The architecture is designed to be modular and scalable, with a clear separation of concerns between different components.

The backend is responsible for:
- User authentication and management.
- Creating and managing free-form and guided journal entries.
- Generating AI-powered prompts and hints for journaling.
- Analyzing journal entries for mood and insights.
- Storing and retrieving journal data from Raindrop SmartBuckets and a local database.

## 2. Core Components

The application is structured into the following key directories:

- **`/app/routes`**: Defines the API endpoints that the frontend interacts with. Each route is responsible for handling incoming requests, validating data, and calling the appropriate service to perform the business logic.
- **`/app/services`**: Contains the core business logic of the application. Each service encapsulates a specific domain, such as `free_journal_service` for free-form journaling or `guided_journal_service` for guided journaling.
- **`/app/models`**: Defines the data models used throughout the application, including database models (using SQLModel) and Pydantic models for API request and response validation.
- **`/app/utils`**: Contains utility functions that are used across different parts of the application, such as PDF generation.
- **`/app/database.py`**: Manages the database connection and session management.

## 3. Authentication Flow

User authentication is handled through Google OAuth2. The authentication flow is as follows:

1. The frontend initiates the Google OAuth2 login flow.
2. After successful authentication with Google, the frontend receives an authentication token.
3. The frontend sends this token to the backend's `/auth/callback` endpoint.
4. The `auth_service` validates the token with Google and retrieves the user's profile information.
5. A new user is created in the database if they don't already exist.
6. The `jwt_service` generates a JSON Web Token (JWT) for the user.
7. This JWT is sent back to the frontend and is used to authenticate subsequent API requests.

## 4. Journaling Features

The application supports two types of journaling: free-form and guided.

### Free-Form Journaling

- **Creation**: Users can create a new free-form journal session, which is initially empty.
- **Content Saving**: As the user writes, the content is saved to the database. The application ensures that empty journals are not saved.
- **AI-Powered Hints**: The `free_journal_service` uses AI to generate contextual hints to help users continue writing. These hints are generated by the `generate_real_hint` method, which uses Google Gemini (with an OpenAI fallback) to create unique and thoughtful suggestions. The generated hints are stored in the `hints` SmartBucket for tracking and analysis.

### Guided Journaling

- **Prompt Generation**: The `guided_journal_service` generates a set of AI-powered prompts based on a user-selected topic. It uses the `generate_real_prompts` method, which leverages Google Gemini (with an OpenAI fallback) to create a series of questions designed to guide the user's reflection.
- **Journal Creation**: Once the prompts are generated, a new guided journal is created. The journal, along with its prompts and user entries, is stored as a single JSON object in the `guided-journals` SmartBucket.
- **Data Storage**: Using SmartBuckets for guided journals allows for a flexible, schema-less approach to storing complex, nested data structures, which is ideal for this type of content.

## 5. AI-Powered Features & Raindrop Integration

The PAUZ backend is deeply integrated with Raindrop to provide a rich set of AI-powered features.

### SmartBuckets

SmartBuckets are used for storing and managing various types of data:

- **`guided-journals`**: Stores complete guided journal entries, including the topic, prompts, and user responses, as single JSON objects.
- **`hints`**: This bucket is used in two ways:
    1.  To store the AI-generated hints for the free-form journaling feature.
    2.  As a fallback storage location for guided journals if the `guided-journals` bucket is not available.
- **`journal-prompts`**: Stores the AI-generated prompts for the guided journaling feature.
- **`journal-analysis`**: Used to store the results of AI-powered mood analysis of journal entries.
- **`garden`**: Stores mood tracking data, which is used to create the user's personal "garden".

### SmartMemory

While not explicitly detailed in the code I've seen so far, based on the file `test_smartmemory.py`, it seems there is an intention to use SmartMemory for:
- **`user-memories`**: Storing user session context to provide a more personalized experience.
- **`ai-contexts`**: Storing AI generation contexts to improve the quality and consistency of AI-generated content.

### Mood Analysis

The `free_journal_service` includes an `analyze_mood_with_gemini` method that uses Google Gemini to analyze the user's journal entry and determine the primary mood. The results, including the mood, insights, a summary, and follow-up questions, are then used to create an entry in the user's garden.

## 6. Data Persistence

The application uses a hybrid approach to data persistence:

- **PostgreSQL/SQLite Database**: A relational database is used to store structured data, such as user information and free journal entries.
- **Raindrop SmartBuckets**: SmartBuckets are used to store unstructured and semi-structured data, such as guided journals, AI-generated content, and analysis results. This allows for greater flexibility and scalability, especially for content that doesn't fit neatly into a relational schema.

## 7. Architecture Diagram

```
+----------------+      +-----------------+      +------------------+
|                |      |                 |      |                  |
|   Frontend     +----->+   FastAPI App   +----->+  Google OAuth2   |
|                |      |                 |      |                  |
+----------------+      +-------+---------+      +------------------+
                                |
                                |
          +---------------------+---------------------+
          |                                           |
+---------v---------+                         +-------v----------+
|                   |                         |                  |
|   /app/routes     +------------------------->  /app/services   |
| (API Endpoints)   |                         | (Business Logic) |
|                   |                         |                  |
+-------------------+                         +---------+--------+
                                                        |
          +---------------------------------------------+---------------------------------------------+
          |                                             |                                             |
+---------v---------+                         +---------v---------+                         +---------v---------+
|                   |                         |                   |                         |                   |
|  /app/models      |                         |  Database         |                         |  Raindrop         |
|(Data Definitions)|                         | (PostgreSQL/      |                         |  (SmartBuckets,   |
|                   |                         |  SQLite)          |                         |   SmartMemory)    |
+-------------------+                         +-------------------+                         +-------------------+

```
